## Big5 Ad LLM – End-to-End Pipeline

An end-to-end workflow to simulate ad evaluations with LLMs, parse raw outputs, convert to tabular data, and run SEM analyses (single-group and multi-group/region).

### Overview
- Prompt LLMs to rate ads under different personality profiles (BFI-15) and demographics.
- Save raw model responses and metadata.
- Parse responses into JSON, then flatten to CSV.
- Merge CSVs across runs per model and split by ad_type.
- Fit SEM models (single-group and multi-group/region) and visualize results.

### Directory Structure
- `0_LLM_questionare_generation.ipynb`: Generates prompts, runs models, saves raw responses to `response_output/` and metadata.
- `1_response_to_json.py`: Parses raw responses from `response_output/` → `json_output/` (robust JSON extraction/fallbacks).
- `2_json_to_csv.py`: Traverses `json_output/` and writes per-experiment CSVs into `csv_output/` (handles fields and scoring rules).
- `3_merge_csv_by_model.py`: Merges per-model CSVs across runs and writes per-`ad_type` CSVs to `csv_output_merged/`.
- `4_multi_group_sem.ipynb`: Multi-group measurement invariance and cross-region path analyses.
- `5_sem.ipynb`: Single-group SEM, standardized plots, and bootstrap effect summaries.
- `response_output/`: Raw `.txt` model responses and `*_metadata.json` per sample.
- `json_output/`: Parsed JSON outputs, one per response.
- `csv_output/`: Flattened CSVs per experiment folder.
- `csv_output_merged/`: Merged CSVs per model and ad_type.
- `sem_outputs/`, `sem_group_outputs/`: Figures and tables generated by SEM analyses.

### Requirements
- Python 3.10+
- Local LLM runtime (e.g., `ollama`) if you plan to re-run generation.

Install dependencies:
```bash
pip install -r requirements.txt
```

Or install manually:
```bash
pip install pandas numpy scipy semopy matplotlib seaborn jupyter ipykernel ipywidgets json5
```

### Workflow
1) Generate responses (optional if you already have data)
   - Open `0_LLM_questionare_generation.ipynb`.
   - Set `region` (e.g., `"Chinese"`, `"America"`, `"Arab"`, `"Southeast_asian"`).
   - Configure `MODELS`, `N_SAMPLES`, `REPEAT_EACH_MODEL`.
   - Run to produce raw files in `response_output/experiment_responses_{model}_{run}/` with paired `*_metadata.json`.

2) Parse raw → JSON
   - Run:
     ```bash
     python 1_response_to_json.py
     ```
   - Writes parsed JSON files to `json_output/experiment_outputs_{model}_{run}/`.
   - Also logs a brief success/error summary to console and stores parse errors alongside outputs.

3) JSON → CSV
   - Run:
     ```bash
     python 2_json_to_csv.py
     ```
   - Auto-traverses `json_output/experiment_outputs_*` and writes CSVs into `csv_output/`.
   - Fields include demographics (e.g., `region`), BFI_11..BFI_53, four `ad_att_*`, and three `intent_*` columns.
   - Notes:
     - Only the first 4 ad-attitude scores and first 3 intention scores are kept.
     - Reverse-scored BFI items are handled internally.

4) Merge CSVs per model and split by ad_type
   - Run:
     ```bash
     python 3_merge_csv_by_model.py
     ```
   - Produces files like `{model}_promotion.csv`, `{model}_prevention.csv`, etc., in `csv_output_merged/`.

5) SEM analyses
   - Single-group: open `5_sem.ipynb`.
     - Loads a merged CSV, fits SEM, outputs standardized plots and effect tables to `sem_outputs/`.
   - Multi-group/region: open `4_multi_group_sem.ipynb`.
     - Supports configural/metric/scalar invariance checks.
     - Produces cross-group comparisons and heatmaps to `sem_group_outputs/`.

### Key Configuration Notes
- Region is externally specified in the generation notebook and flows through metadata → JSON → CSV.
- `2_json_to_csv.py` automatically ignores checkpoint files and hidden files.
- CSV header includes `region`; ensure downstream code expects this.

### Troubleshooting
- “dict contains fields not in fieldnames: 'region'”
  - Ensure your CSV writer’s `fieldnames` includes `region` (already handled in `2_json_to_csv.py`).
- Duplicate rows
  - Often caused by parsing files under `.ipynb_checkpoints`; the CSV converter already filters these.
- Non-JSON raw responses
  - `1_response_to_json.py` uses multiple strategies (cleaning/regex/AST/fallback extraction). Failures are logged and saved for review.

### Repro Tips
- Keep a clean `response_output/` → `json_output/` → `csv_output/` → `csv_output_merged/` chain.
- If you change prompts, re-run from parsing onward.
- Use consistent model/run naming; the merge script relies on `{model}_{run}.csv` patterns.